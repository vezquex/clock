<!doctype html>
<meta charset='utf-8'/>
<meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>
	World
</title>
<style type='text/css'>
	:root {
		--accent: #808080;
		accent-color: var(--accent);
		color-scheme: dark;
	}
	body, input, select {
		background: #000;
		color: #FFF;
		display: flex;
		flex-direction: column;
		font-family: sans-serif;
		font-size: 1em;
		margin: 0;
	}
	label {
		display: flex;
	}
	input, select, .label {
		border: 0;
		opacity: 0.5;
		padding: .5em;
	}
	button, select {
		cursor: pointer;
		flex-grow: 1;
	}
	.flex {
		display: flex;
	}
</style>

<input id='offset' title='Demo Offset' value='0' type='range' max='86400000' step='100000' onChange='synchronize()'>
<label>
	<span class='label'>Theme</span>
	<select id='theme' title='Theme' onChange='setTheme(this.value)'></select>
</label>
<div class="flex">
	<button id="zone_dec" onMouseDown="zone_dec()">Z-</button>
	<button id="zone_inc" onMouseDown="zone_inc()">Z+</button>
</div>
<div><canvas id='face'></canvas></div>

<script type="text/javascript">
const months = ["JAN.", "FEB.", "MAR.", "APR.", "MAY", "JUNE", "JULY", "AUG.", "SEPT", "OCT.", "NOV.", "DEC."]

const city_info = [
	[-11, "PPG", "Pago Pago"],
	[-10, "HNL", "Honolulu"],
	[-9, "ANC", "Anchorage"],
	[-8, "LAX", "Los Angeles"],
	[-8, "YVR", "Vancouver"],
	[-7, "DEN", "Denver"],
	[-7, "YEA", "Edmonton"],
	[-6, "CHI", "Chicago"],
	[-6, "MEX", "Mexico City"],
	[-5, "NYC", "New York City"],
	[-5, "YTO", "Toronto"],
	[-4, "SCL", "Santiago"],
	[-3.5 , "YYT", "St. John\'s"],
	[-3, "RIO", "Rio de Janeiro"],
	[-2, "FEN", "Fernando de Noronha"],
	[-1, "RAI", "Praia"],
	[0, "UTC", "Universal Coordinated Time"],
	[0, "LIS", "Lisbon"],
	[0, "LON", "London"],
	[1, "MAD", "Madrid"],
	[1, "PAR", "Paris"],
	[1, "ROM", "Rome"],
	[2, "ANK", "Ankara"],
	[2, "ATH", "Athens"],
	[2, "CAI", "Cairo"],
	[2, "HEL", "Helsinki"],
	[3, "BGW", "Baghdad"],
	[3.5, "THR", "Tehran"],
	[4, "DXB", "Dubai"],
	[4.5, "KBL", "Kabul"],
	[5, "KHI", "Karachi"],
	[5.5, "DEL", "Delhi"],
	[5.75, "KTM", "Kathmandu"],
	[6, "DAC", "Dhaka"],
	[6.5, "RGN", "Yangon"],
	[7, "BKK", "Bangkok"],
	[8, "KUL", "Kuala Lumpur"],
	[8, "SIN", "Singapore"],
	[8, "TPE", "Taipei"],
	[9, "TYO", "Tokyo"],
	[9.5, "ADL", "Adelaide"],
	[10, "SYD", "Sydney"],
	[11, "NOU", "Noumea"],
	[12, "WLG", "Wellington"],
]

let font = "block_world"
let palettes
const color_palettes = {
	"black": "#000000",
	"gray_1_3": "#555555",
	"gray_2_3": "#AAFAAA",
	'white': '#F1EDDB',
}

const four_negative = ["black", "gray_1_3", "gray_2_3", "white"]
const four_positive = [...four_negative].reverse()
const themes = {
	Dark: {
		_scale: four_negative,
		_body: "3",
		background: color_palettes.black,
		color: color_palettes.white,
	},
	Light: {
		_scale: four_positive,
		_body: "3",
		background: color_palettes.white,
		color: color_palettes.black,
	},
}
for(k in themes){
	const theme = themes[k]
	;(theme._scale||[]).forEach((color, i)=>theme[i] = color_palettes[color])
	Object.assign(theme, color_palettes)
}
document.getElementById("theme").innerHTML = Object.keys(themes).map(t => `<option value="${t}">${t}</option>`).join("")


const char_height = 10
const char_width = 14
const grid_w = char_width + 0
const grid_w2 = grid_w * 2

const _ = void 0

const can = document.getElementById("face")
const c = can.getContext("2d")

const height = 80
const width = 160
const pad_h = 2
const pad_v = 4

// zoom
let z = 1

can.height = height * z
can.width = width * z
c.setTransform(z, 0, 0, z, 0, 0)

const offset_el = document.getElementById("offset")

const sym_w = 5
const sym_a = sym_w * sym_w
// const sym_w2 = sym_w * 2
const g = sym_w + 1

// base-2 for single color pixel font
// base-3 for 1 extra color, and so forth
// base-36 for text storage
function encode_font(font){
	return Object.fromEntries(Object.entries(font).map(([k,v])=>([k,
		parseInt(v.join("").padEnd(sym_a, "0"), 3).toString(36)
	])))
}
function fold_font(font){
	const width = new RegExp(`(.{${sym_w}})`)
	return Object.fromEntries(Object.entries(font).map(([k,v])=>([k,
		v.join("").padEnd(sym_a, "0").split(width).slice(1,-1).join("\n")
	])))
}
const fonts_decode = {}
fonts_decode.block36 = (s)=>parseInt(s, 36).toString(3).padStart(sym_a, "0").split("").map(s=>parseInt(s))
fonts_decode.block_world = (s)=>s.replace(/\s/g, "").padEnd(sym_a, "0").split("").map(s=>parseInt(s))
// const block36 = encode_font(fonts.block)
let fonts = {
	block_world: {
  "0": `
11111
10001
10201
10001
11111
`,
  "1": `
01100
00100
00100
00100
00100
`,
  "2": `
11111
00001
11111
10000
11111
`,
  "3": `
11111
00001
01111
00001
11111
`,
  "4": `
10001
10001
11111
00001
00001
`,
  "5": `
11111
10000
11111
00001
11111
`,
  "6": `
11111
10000
11111
10001
11111
`,
  "7": `
11111
00001
00001
00001
00001
`,
  "8": `
11111
10001
11111
10001
11111
`,
  "9": `
11111
10001
11111
00001
00001
`,
  "missing": `
22222
22202
20202
20222
22222
`,
  " ": `
00000
00000
00000
00000
00000
`,
  "A": `
11111
10001
11111
10001
10001
`,
  "B": `
11110
10010
11111
10001
11111
`,
  "C": `
11111
10001
10000
10001
11111
`,
  "D": `
11110
10011
10001
10011
11110
`,
  "E": `
11111
10000
11110
10000
11111
`,
  "F": `
11111
10000
11110
10000
10000
`,
  "G": `
11111
10000
10111
10001
11111
`,
  "H": `
10001
10001
11111
10001
10001
`,
  "I": `
11111
00100
00100
00100
11111
`,
  "J": `
00001
00001
00001
10001
11111
`,
  "K": `
10010
10010
11111
10001
10001
`,
  "L": `
10000
10000
10000
10000
11111
`,
  "M": `
11111
10101
10101
10101
10101
`,
  "N": `
11111
10001
10001
10001
10001
`,
  "O": `
11111
10001
10001
10001
11111
`,
  "P": `
11111
10001
11111
10000
10000
`,
  "Q": `
11110
10010
10010
10010
11111
`,
  "R": `
11111
10001
11111
10010
10011
`,
  "S": `
11111
10000
11111
00001
11111
`,
  "T": `
11111
00100
00100
00100
00100
`,
  "U": `
10001
10001
10001
10001
11111
`,
  "V": `
10001
10001
11011
01010
01110
`,
  "W": `
10101
10101
10101
10101
11111
`,
  "X": `
10001
11011
01110
11011
10001
`,
  "Y": `
10001
10001
11111
00100
00100
`,
  "Z": `
11111
00011
01110
11000
11111
`,
  "%": `
10001
00010
00100
01000
10001
`,
  "-": `
00000
00000
01110
00000
00000
`,
	"+": `
00000
00100
01110
00100
00000
`,
".": `
00000
00000
00000
00000
10000
`,
  ":": `
00000
00100
00000
00100
00000
`,
  "_": `
00000
00000
00000
00000
11111
`,
"/": `
00001
00010
00100
01000
10000
`,
  "ðŸ”‹": `
01110
11111
10001
10001
11111
`,
  "â–ˆ": `
11111
11111
11111
11111
11111`
},
}

for(f in fonts){
	const decode = fonts_decode[f]
	if(!decode) continue
	const font = fonts[f]
	for(char in font){
		font[char] = decode(font[char])
	}
}

function setTheme(theme){
	palettes = themes[theme]
	document.getElementById("face").style.backgroundColor = palettes.background
	document.querySelector(`#theme [value=${theme}]`).selected = true
	synchronize()
}
function setTheme(theme){
	palettes = themes[theme]
	can.style.backgroundColor = palettes.background
	document.querySelector(`#theme [value=${theme}]`).selected = true
	document.documentElement.style.setProperty('--accent', palettes.color)
	synchronize()
}

function str(s, x, y, m = 1, p = palettes._body, f = font, ctx = c){
	s = [...s] // unicode
	for(var i = 0; i < s.length; ++i){
		symbol(
			s[i],
			x + i,
			y, m, p, f, ctx
		)
	}
}

function strv(s, x, y, m = 1, p = palettes._body, f = font, ctx = c){
	s = [...s] // unicode
	for(var i = 0; i < s.length; ++i){
		symbol(
			s[i],
			x,
			y + i*z,
			m, p, f, ctx
		)
	}
}

function symbol(s, x, y, m, p, f, c = c){
	const font = fonts[f]
	const bmp = font[s] || font.missing || fonts.block.missing
	const l = bmp.length
	for(var i = 0; i < l; ++i){
		let b = bmp[i]
		if(b === 0) continue
		c.fillStyle = palettes[p]
		c.fillRect(
			(m * (x * g + (i % sym_w)) + pad_h),
			((y * g + m * Math.floor(i / sym_w)) + pad_v),
			m, m
		)
	}
}

let mem_zone = 0

function zone_dec(){
	mem_zone -= 1
	if(mem_zone < -11){
		mem_zone = 12
	}
	synchronize()
}
function zone_inc(){
	mem_zone += 1
	if(mem_zone > 12){
		mem_zone = -11
	}
	synchronize()
}

function zone_desc(zone){
	const prefix = (zone > 0) ? "+" : (zone < 0) ? "-" : ""
	return `${prefix}${(((Math.abs(zone))||"UTC")+"").padStart(2, "0")}`
}

function synchronize(){
	window.clearTimeout(window.synchronizeTimeout)
	const offset = Number(offset_el.value) + (mem_zone * 36e5)
	const t = new Date(Date.now() + offset)
	display(t)
	const r = 1000 - (t % 1000)
	// window.synchronizeTimeout = window.setTimeout(synchronize, r)
}

function zeropad2(s){
	return ('0' + s).slice(-2)
}

const char_masks = {
	'0': 0b111111,
	'1': 0b1001,
	'2': 0b1110101,
	'3': 0b1101101,
	'4': 0b1001011,
	'5': 0b1101110,
	'6': 0b1111110,
	'7': 0b1101,
	'8': 0b1111111,
	'9': 0b1101111,
	' ': 0,
	'.': 0b100000000,
	'-': 0b1000000,
	':': 0b110000000,
	'A': 0b1011111,
	'B': 0b1000000110101101,
	'C': 0b110110,
	'D': 0b110101101,
	'E': 0b1110110,
	'F': 0b1010110,
	'G': 0b1000000000111110,
	'H': 0b1011011,
	'I': 0b110100100,
	'J': 0b111001,
	'K': 0b1100001011011,
	'L': 0b110010,
	'M': 0b110011111,
	'N': 0b0000011111,
	'O': 0b111111,
	'P': 0b1010111,
	'Q': 0b1000000111111,
	'R': 0b1001011111,
	'S': 0b1101110,
	'T': 0b110000100,
	'T2': 0b1000010110,
	'T3': 0b100000001101,
	'U': 0b111011,
	'V': 0b100010011,
	'W': 0b100111011,
	'X': 0b1111001011011,
	'Y': 0b101000011,
	'Z': 0b1110101,
	'?': 0b11111111111,
}

const db = [[4,11.625], [6,11.625], [6,9], [5,8.25], [4,9]]
const dc = [[.25,14], [9.75,14], [7.75,12], [2.25,12]]
const dl = [[0,13.75], [2,11.75], [2,8.25], [1,7.25], [0,8.25]]
const dlt = [[-.375,14], [-4,14], [-3,12], [-.375,12]]
const drt = [[10.375,14], [14,14], [13,12], [10.375,12]]
const dr = [[10,13.75], [8,11.75], [8,8.25], [9,7.25], [10,8.25]]
const ult = [[-.375,0], [-4,0], [-3,2], [-.375,2]]
const urt = [[10.375,0], [14,0], [13,2], [10.375,2]]
const mc = [[1.25, 7], [2.25,6], [7.75,6], [8.75, 7], [7.75,8], [2.25,8]]
const mr = [[5,6], [7.75,6], [8.75, 7], [7.75,8], [5,8]]
const mlt = [[-4, 7], [-3,6], [-.25,6], [.75, 7], [-.25,8], [-3,8]]
const mrt = [[14, 7], [13,6], [10.25,6], [9.25, 7], [10.25,8], [13.25,8]]
const ub = [[4,2.375], [6,2.375], [6,5], [5,5.75], [4,5]]
const uc = [[.25,0], [9.75,0], [7.75,2], [2.25,2]]
const ul = [[0,.25], [2,2.25], [2,5.75], [1,6.75], [0,5.75]]
const ur = [[10,.25], [8,2.25], [8,5.75], [9,6.75], [10,5.75]]

const segs = [ur, ul, uc, dr, dl, dc, mc, ub, db, ult, dlt, urt, drt, mlt, mrt, mr]

function mask_segs(mask){
	let s = []
	let i = 0
	let i_mask = 1
	while(i_mask <= mask){
		if(mask & i_mask){
			s.push(segs[i])
		}
		++i
		i_mask = i_mask << 1
	}
	return s
}

const char_paths = Object.fromEntries(
	Object.entries(char_masks).map(
		([k, mask], i) => [k, mask_segs(mask)]
	)
)

function shape(path, x, y, m = 1){
	m = m*z
	c.beginPath()
	c.moveTo((path[0][0] + x)*m, (path[0][1] + y)*m)
	for(i=1; i<path.length; ++i){
		c.lineTo((path[i][0] + x)*m, (path[i][1] + y)*m)
	}
	c.fill()
}

function draw_char(s, x, y, m = 1){
	(char_paths[s] || char_paths['?']).forEach(
		path => shape(path, x, y, m)
	)
}

function draw_str(chars, x, y, m = 1, gw = grid_w){
	if(!(chars instanceof Array)){
		chars = (chars+'').split('')
	}
	chars.forEach((s, i) => {
		draw_char(s, x + i * gw, y, m)
	})
}
const tau = 2 * Math.PI
const colon_sides = 6
const colon_radius = 1.16
const colon_shape = Array(colon_sides).fill().map((_,i)=>([
	colon_radius * Math.cos(i * tau / colon_sides),
	colon_radius * Math.sin(i * tau / colon_sides),
]))
function colon(x, y){
	shape(colon_shape, x, y+5)
	shape(colon_shape, x, y+9)
}

const weekdays = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT']
function display(t){
	const day_of_month = zeropad2(t.getUTCDate())
	const month = zeropad2(t.getUTCMonth()+1)
	const month_name = months[t.getUTCMonth()]
	const year = t.getUTCFullYear()
	const numdate = `${year}-${month}-${day_of_month}`
	const weekday = weekdays[t.getUTCDay()]
	const hours = zeropad2(t.getUTCHours())
	const minutes = zeropad2(t.getUTCMinutes())
	const seconds = zeropad2(t.getUTCSeconds())

	c.fillStyle = palettes.color
	c.clearRect(0, 0, width*z, height*z)
	x = pad_h, y = pad_v, m = .25
	draw_str(month_name+' '+weekday, x = (pad_h + grid_w*2.75)/m, y/m, m)
	y += 6
	m = .5
	draw_str(numdate, x = pad_h/m, y/m, m)
	y += 10
	draw_str(hours, x = pad_h, y)
	colon(x+29.5, y)
	draw_str(minutes, x += grid_w2+7, y)
	m = 0.75
	draw_str(seconds, (x + grid_w2)/m, (y+3.5)/m, m)

	y += 12
	const tiles = 24
	for(var i = 0; i < tiles; ++i){
		let zone = i - 11
		let lit = zone === mem_zone
		c.fillStyle = palettes[lit ? 2 : 1]
		c.fillRect(
			i * g * z,
			y * g,
			sym_w * z,
			g*3 * z,
		)
		strv(
			zone_desc(zone),
			i,
			y,
			z,
			lit ? 1 : 3
		)
	}
	y += 4
	const city_codes = city_info.filter(a => a[0] === mem_zone)
	.map(info => info[1])
	str(city_codes.join("/"), 0, y+=12, z)
}

function resize(){
	const scale = window.devicePixelRatio || 1
	z = Math.floor(Math.min(
		window.innerWidth / width,
		window.innerHeight / height,
	))
	can.height = height * scale * z
	can.width = width * scale * z
	can.style.height = (height*z)+'px'
	can.style.width = (width*z)+'px'
	c.scale(scale, scale)
	synchronize()
}

window.addEventListener('resize', resize)

setTheme('Dark')

resize()

</script>