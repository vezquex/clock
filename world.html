<!doctype html>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width" />
<title>
	World
</title>
<style type="text/css">
	:root {color-scheme: dark;}
	body, input, select {
		background: #000;
		color: #FFF;
		display: flex;
		flex-direction: column;
		font-family: sans-serif;
		font-size: 1em;
		margin: 0;
	}
	button {
		cursor: pointer;
	}
	.flex {
		display: flex;
	}
	input, select, .label {
		border: 0;
		padding: .5em;
	}
	button, select {
		flex-grow: 1;
	}
</style>

<input id="offset" title="Demo Offset" value="0" type="range" max="86400000" step="100000" onChange="synchronize()">
<label class="flex">
	<span class="label">Theme</span>
	<select id="theme" title="Theme" onChange="setTheme(this.value)"></select>
</label>
<div class="flex">
	<button id="zone_dec" onMouseDown="zone_dec()">Z-</button>
	<button id="zone_inc" onMouseDown="zone_inc()">Z+</button>
</div>
<div><canvas id="face"></canvas></div>

<script type="text/javascript">

let font = "block_world"
let palettes
const color_palettes = {
	"black": {
		1: "#000000",
	},
	"gray_1_3": {
		1: "#555555",
	},
	"gray_2_3": {
		1: "#AAFAAA",
	},
	"white": {
		1: "#FFFFFF",
	},
}
const four_negative = ["black", "gray_1_3", "gray_2_3", "white"]
const four_positive = [...four_negative].reverse()
const themes = {
	Dark: {
		_scale: four_negative,
		_body: "3",
		background: color_palettes.black[1],
	},
	Light: {
		_scale: four_positive,
		_body: "3",
		background: color_palettes.white[1],
	},
}
for(k in themes){
	const theme = themes[k]
	;(theme._scale||[]).forEach((color, i)=>theme[i] = color_palettes[color])
	Object.assign(theme, color_palettes)
}
document.getElementById("theme").innerHTML = Object.keys(themes).map(t => `<option value="${t}">${t}</option>`).join("")


const locale = "en-us"
const months = ["JAN.", "FEB.", "MAR.", "APR.", "MAY", "JUNE", "JULY", "AUG.", "SEPT", "OCT.", "NOV.", "DEC."]

const city_info = [
	[-11, "PPG", "Pago Pago"],
	[-10, "HNL", "Honolulu"],
	[-9, "ANC", "Anchorage"],
	[-8, "LAX", "Los Angeles"],
	[-8, "YVR", "Vancouver"],
	[-7, "DEN", "Denver"],
	[-7, "YEA", "Edmonton"],
	[-6, "CHI", "Chicago"],
	[-6, "MEX", "Mexico City"],
	[-5, "NYC", "New York City"],
	[-5, "YTO", "Toronto"],
	[-4, "SCL", "Santiago"],
	[-3.5 , "YYT", "St. John\'s"],
	[-3, "RIO", "Rio de Janeiro"],
	[-2, "FEN", "Fernando de Noronha"],
	[-1, "RAI", "Praia"],
	[0, "UTC", "Universal Coordinated Time"],
	[0, "LIS", "Lisbon"],
	[0, "LON", "London"],
	[1, "MAD", "Madrid"],
	[1, "PAR", "Paris"],
	[1, "ROM", "Rome"],
	[2, "ANK", "Ankara"],
	[2, "ATH", "Athens"],
	[2, "CAI", "Cairo"],
	[2, "HEL", "Helsinki"],
	[3, "BGW", "Baghdad"],
	[3.5, "THR", "Tehran"],
	[4, "DXB", "Dubai"],
	[4.5, "KBL", "Kabul"],
	[5, "KHI", "Karachi"],
	[5.5, "DEL", "Delhi"],
	[5.75, "KTM", "Kathmandu"],
	[6, "DAC", "Dhaka"],
	[6.5, "RGN", "Yangon"],
	[7, "BKK", "Bangkok"],
	[8, "KUL", "Kuala Lumpur"],
	[8, "SIN", "Singapore"],
	[8, "TPE", "Taipei"],
	[9, "TYO", "Tokyo"],
	[9.5, "ADL", "Adelaide"],
	[10, "SYD", "Sydney"],
	[11, "NOU", "Noumea"],
	[12, "WLG", "Wellington"],
]

const _ = void 0

const can = document.getElementById("face")
const c = can.getContext("2d")

const height = 80
const width = 160
const pad_h = 0
const pad_v = 0

// zoom dev
const z = 3
can.height = height * z
can.width = width * z
c.setTransform(z, 0, 0, z, 0, 0)

const offset_el = document.getElementById("offset")

const sym_w = 5
const sym_a = sym_w * sym_w
const sym_w2 = sym_w * 2
const g = sym_w + 1
const g2 = g * 2
const tiles_h = Math.ceil(width / g * .5)
const tiles_v = Math.ceil(height / g * .5) - 1
const slots_h = Math.floor((width - pad_h) / g)

// base-2 for single color pixel font
// base-3 for 1 extra color, and so forth
// base-36 for text storage
function encode_font(font){
	return Object.fromEntries(Object.entries(font).map(([k,v])=>([k,
		parseInt(v.join("").padEnd(sym_a, "0"), 3).toString(36)
	])))
}
function fold_font(font){
	const width = new RegExp(`(.{${sym_w}})`)
	return Object.fromEntries(Object.entries(font).map(([k,v])=>([k,
		v.join("").padEnd(sym_a, "0").split(width).slice(1,-1).join("\n")
	])))
}
const fonts_decode = {}
fonts_decode.block36 = (s)=>parseInt(s, 36).toString(3).padStart(sym_a, "0").split("").map(s=>parseInt(s))
fonts_decode.block_world = (s)=>s.replace(/\s/g, "").padEnd(sym_a, "0").split("").map(s=>parseInt(s))
// const block36 = encode_font(fonts.block)
let fonts = {
	block_world: {
  "0": `
11111
10001
10201
10001
11111
`,
  "1": `
01100
00100
00100
00100
00100
`,
  "2": `
11111
00001
11111
10000
11111
`,
  "3": `
11111
00001
01111
00001
11111
`,
  "4": `
10001
10001
11111
00001
00001
`,
  "5": `
11111
10000
11111
00001
11111
`,
  "6": `
11111
10000
11111
10001
11111
`,
  "7": `
11111
00001
00001
00001
00001
`,
  "8": `
11111
10001
11111
10001
11111
`,
  "9": `
11111
10001
11111
00001
00001
`,
  "missing": `
22222
22202
20202
20222
22222
`,
  " ": `
00000
00000
00000
00000
00000
`,
  "A": `
11111
10001
11111
10001
10001
`,
  "B": `
11110
10010
11111
10001
11111
`,
  "C": `
11111
10001
10000
10001
11111
`,
  "D": `
11110
10011
10001
10011
11110
`,
  "E": `
11111
10000
11110
10000
11111
`,
  "F": `
11111
10000
11110
10000
10000
`,
  "G": `
11111
10000
10111
10001
11111
`,
  "H": `
10001
10001
11111
10001
10001
`,
  "I": `
11111
00100
00100
00100
11111
`,
  "J": `
00001
00001
00001
10001
11111
`,
  "K": `
10010
10010
11111
10001
10001
`,
  "L": `
10000
10000
10000
10000
11111
`,
  "M": `
11111
10101
10101
10101
10101
`,
  "N": `
11111
10001
10001
10001
10001
`,
  "O": `
11111
10001
10001
10001
11111
`,
  "P": `
11111
10001
11111
10000
10000
`,
  "Q": `
11110
10010
10010
10010
11111
`,
  "R": `
11111
10001
11111
10010
10011
`,
  "S": `
11111
10000
11111
00001
11111
`,
  "T": `
11111
00100
00100
00100
00100
`,
  "U": `
10001
10001
10001
10001
11111
`,
  "V": `
10001
10001
11011
01110
00100
`,
  "W": `
10101
10101
10101
10101
11111
`,
  "X": `
10001
11011
01110
11011
10001
`,
  "Y": `
10001
10001
11111
00100
00100
`,
  "Z": `
11111
00011
01110
11000
11111
`,
  "%": `
10001
00010
00100
01000
10001
`,
  "-": `
00000
00000
01110
00000
00000
`,
	"+": `
00000
00100
01110
00100
00000
`,
".": `
00000
00000
00000
00000
10000
`,
  ":": `
00000
00100
00000
00100
00000
`,
  "_": `
00000
00000
00000
00000
11111
`,
"/": `
00001
00010
00100
01000
10000
`,
  "ðŸ”‹": `
01110
11111
10001
10001
11111
`,
  "â–ˆ": `
11111
11111
11111
11111
11111`
},
}

for(f in fonts){
	const decode = fonts_decode[f]
	if(!decode) continue
	const font = fonts[f]
	for(char in font){
		font[char] = decode(font[char])
	}
}

function setTheme(theme){
	palettes = themes[theme]
	document.getElementById("face").style.backgroundColor = palettes.background
	document.querySelector(`#theme [value=${theme}]`).selected = true
	synchronize()
}

function str(s, x, y, m = 1, p = palettes._body, f = font, ctx = c){
	s = [...s] // unicode
	for(var i = 0; i < s.length; ++i){
		symbol(
			s[i],
			x + i,
			y, m, p, f, ctx
		)
	}
}

function strv(s, x, y, m = 1, p = palettes._body, f = font, ctx = c){
	s = [...s] // unicode
	for(var i = 0; i < s.length; ++i){
		symbol(
			s[i],
			x,
			y + i,
			m, p, f, ctx
		)
	}
}

function symbol(s, x, y, m, p, f, c = c){
	const font = fonts[f]
	const bmp = font[s] || font.missing || fonts.block.missing
	const l = bmp.length
	for(var i = 0; i < l; ++i){
		let b = bmp[i]
		if(b === 0) continue
		c.fillStyle = palettes[p][b]
		c.fillRect(
			(m * (x * g + (i % sym_w)) + pad_h),
			((y * g + m * Math.floor(i / sym_w)) + pad_v),
			m, m
		)
	}
}

let mem_zone = 0


function zone_dec(){
	mem_zone -= 1
	if(mem_zone < -11){
		mem_zone = 12
	}
	synchronize()
}
function zone_inc(){
	mem_zone += 1
	if(mem_zone > 12){
		mem_zone = -11
	}
	synchronize()
}

function zone_desc(zone){
	const prefix = (zone > 0) ? "+" : (zone < 0) ? "-" : ""
	return `${prefix}${(((Math.abs(zone))||"UTC")+"").padStart(2, "0")}`
}

function synchronize(){
	const offset = Number(offset_el.value) + (mem_zone * 36e5)
	const t = new Date(Date.now() + offset)
	display(t)
}

function zeropad2(s){
	return ("0" + s).slice(-2)
}

function display(t){
	const month = months[t.getMonth()]
	const weekday = t.toLocaleString(locale, { weekday: "long" }).toUpperCase()
	const hours = t.getHours()
	const minutes = t.getMinutes()
	const time = zeropad2(hours) + ":" + zeropad2(minutes)
	const seconds = zeropad2(t.getSeconds())
	const numdate =
		t.getFullYear()+
		"-"+
		zeropad2(t.getMonth() + 1)+
		"-"+
		zeropad2(t.getDate())

	c.clearRect(0, 0, width, height)

	let x = y = 8, m = 1

	const tiles = 24
	for(var i = 0; i < tiles; ++i){
		let zone = i - 11
		let lit = zone === mem_zone
		c.fillStyle = palettes[lit ? 2 : 1][1]
		c.fillRect(
			i * g,
			y * g,
			sym_w, g*3
		)
		strv(
			zone_desc(zone),
			i, y, 1,
			lit ? 1 : 3
		)
	}
	y += 4
	const city_codes = city_info.filter(a => a[0] === mem_zone)
	.map(info => info[1])
	str(city_codes.join("/"), 0, y)

	x = y = 0
	str(month, 10, y)
	str(weekday.slice(0,3)+".", 16, y)
	str(numdate, 0, y+=1, 2)
	str(time, 0, y+=3, 4)
	str(seconds, 6.6667, y+0.8660254037844386, 3, "1")
	y += 4

	const ms_day = 864e5
	const ms_centiday = 864e3
	const temperature = (t % ms_day) / ms_centiday
}

setTheme("Dark")

synchronize()

</script>
