<!doctype html>
<meta charset='utf-8'/>
<meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>
	World
</title>
<style type='text/css'>
	:root {
		--accent: #808080;
		accent-color: var(--accent);
		color-scheme: dark;
	}
	body, button, input, select {
		background: #000;
		color: #FFF;
		font-family: monospace;
		font-size: 1em;
		margin: 0;
	}
	button, select {
		border-style: outset;
		border-width: 1px;
		cursor: pointer;
		opacity: 0.5;
		padding: .5em;
	}
	button {
		align-items: center;
		justify-content: center;
		flex-grow: 2;
	}
	.grow {
		flex-grow: 1;
	}
	.full-height {
		min-height: 100vh;
	}
	.column {
		display: flex;
		flex-direction: column;
	}
	.row {
		display: flex;
		flex-direction: row;
	}
	@media(hover: none){
		button, select {
			font-size: 2rem;
		}
	}
</style>

<div class='full-height column'>
	<input id='offset' style='display:none;' title='Demo Offset' value='0' type='range' max='86400000' step='100000' onChange='synchronize()'>
	<div class='grow'><canvas id='face'></canvas></div>
	<div id='button_box' class='row'>
		<select id='theme' class='grow' title='Theme' onChange='setTheme(this.value)'></select>
		<button id='zone_dec'><span>-</span></button>
		<button id='zone_inc'><span>+</span></button>
	</div>
</div>

<script type='text/javascript'>
const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUNE', 'JULY', 'AUG.', 'SEPT', 'OCT', 'NOV', 'DEC']
const weekdays = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT']

const city_info = [
	[-11, 'PPG', 'Pago Pago'],
	[-10, 'HNL', 'Honolulu'],
	[-9, 'ANC', 'Anchorage'],
	[-8, 'LAX', 'Los Angeles'],
	// [-8, 'YVR', 'Vancouver'],
	[-7, 'DEN', 'Denver'],
	// [-7, 'YEA', 'Edmonton'],
	// [-6, 'CHI', 'Chicago'],
	[-6, 'MEX', 'Mexico City'],
	[-5, 'NYC', 'New York'],
	// [-5, 'YTO', 'Toronto'],
	[-4, 'SCL', 'Santiago'],
	[-3.5 , 'YYT', 'St. John\'s'],
	[-3, 'RIO', 'Rio_Janeiro'],//Rio de Janeiro
	[-2, 'FEN', 'Fern_Noronha'],//Fernando de Noronha
	[-1, 'RAI', 'Praia'],
	[0, 'UTC', 'Universal'], // Universal Coordinated Time
	// [0, 'LIS', 'Lisbon'],
	// [0, 'LON', 'London'],
	// [1, 'MAD', 'Madrid'],
	[1, 'PAR', 'Paris'],
	// [1, 'ROM', 'Rome'],
	// [2, 'ANK', 'Ankara']
	[2, 'ATH', 'Athens'],
	// [2, 'CAI', 'Cairo'],
	// [2, 'HEL', 'Helsinki'],
	[3, 'BGW', 'Baghdad'],
	[3.5, 'THR', 'Tehran'],
	[4, 'DXB', 'Dubai'],
	[4.5, 'KBL', 'Kabul'],
	[5, 'KHI', 'Karachi'],
	[5.5, 'DEL', 'Delhi'],
	[5.75, 'KTM', 'Kathmandu'],
	[6, 'DAC', 'Dhaka'],
	[6.5, 'RGN', 'Yangon'],
	[7, 'BKK', 'Bangkok'],
	// [8, 'KUL', 'Kuala Lumpur'],
	[8, 'SIN', 'Singapore'],
	// [8, 'TPE', 'Taipei'],
	[9, 'TYO', 'Tokyo'],
	[9.5, 'ADL', 'Adelaide'],
	[10, 'SYD', 'Sydney'],
	[11, 'NOU', 'Noumea'],
	[12, 'WLG', 'Wellington'],
]

let mem_zone = 0
let palettes
const color_palettes = {
	'black': '#000000',
	'gray_1_3': '#804040',
	'gray_2_3': '#5555A5',
	'white': '#F1EDDB',
}

const four_negative = ['black', 'gray_1_3', 'gray_2_3', 'white']
const four_positive = [...four_negative].reverse()
const themes = {
	Dark: {
		_scale: four_negative,
		_body: '3',
		background: color_palettes.black,
		color: color_palettes.white,
	},
	Light: {
		_scale: four_positive,
		_body: '3',
		background: color_palettes.white,
		color: color_palettes.black,
	},
}
for(k in themes){
	const theme = themes[k]
	;(theme._scale||[]).forEach((color, i)=>theme[i] = color_palettes[color])
	Object.assign(theme, color_palettes)
}
document.getElementById('theme').innerHTML = Object.keys(themes).map(t => `<option value='${t}'>${t}</option>`).join('')


const char_height = 14
const char_width = 10
const grid_h = char_height + 1
const grid_w = char_width + 4
const grid_w2 = grid_w * 2

const _ = void 0

const can = document.getElementById('face')
const c = can.getContext('2d')

const height = 44
const width = 89
const pad_h = 2
const pad_v = 4

// zoom
let z = 1

can.height = height * z
can.width = width * z
c.setTransform(z, 0, 0, z, 0, 0)

const offset_el = document.getElementById('offset')

function setTheme(theme){
	palettes = themes[theme]
	can.style.backgroundColor = palettes.background
	document.querySelector(`#theme [value=${theme}]`).selected = true
	document.documentElement.style.setProperty('--accent', palettes.color)
	synchronize()
}

function on_button(event, callback){
	// left mouse button, touch, enter, spacebar
	if (!((event.which === 1) || (event.type === 'touchstart') || (event.keyCode === 13) || (event.keyCode === 32))){
		return
	}
	const self = this
	let interval = null
	let timeout = null

	callback()
	event.preventDefault()

	// cancel interval and timeout; unbind listeners
	function cancel(event){
		window.clearInterval(interval)
		window.clearTimeout(timeout)
		// self.blur()
		self.removeEventListener('keydown', cancel)
		self.removeEventListener('keyup', cancel)
		self.removeEventListener('mouseout', cancel)
		self.removeEventListener('mouseup', cancel)
		self.removeEventListener('mouseup', cancel)
		event.preventDefault()
	}
	self.addEventListener('keydown', cancel)
	self.addEventListener('keyup', cancel)
	self.addEventListener('mouseout', cancel)
	self.addEventListener('mouseup', cancel)
	self.addEventListener('touchend', cancel)

	// long press: repeat
	timeout = window.setTimeout(function(){
		interval = window.setInterval(callback, 100)
	}, 300)
}

function bind_on_button(el, cb){
	el.addEventListener('keydown', function(event){
		on_button.call(this, event, cb)
	})
	el.addEventListener('mousedown', function(event){
		on_button.call(this, event, cb)
	})
	el.addEventListener('touchstart', function(event){
		on_button.call(this, event, cb)
	})
}

bind_on_button(
	document.getElementById('zone_dec'),
	zone_dec
)
bind_on_button(
	document.getElementById('zone_inc'),
	zone_inc
)

function zone_dec(){
	mem_zone -= 1
	if(mem_zone < -11){
		mem_zone = 12
	}
	synchronize()
}
function zone_inc(){
	mem_zone += 1
	if(mem_zone > 12){
		mem_zone = -11
	}
	synchronize()
}

function zone_desc(zone){
	const prefix = (zone > 0) ? '+' : (zone < 0) ? '-' : ''
	return `${prefix}${(((Math.abs(zone))||'UTC')+'').padStart(2, '0')}`
}

function synchronize(){
	window.clearTimeout(window.synchronizeTimeout)
	const offset = Number(offset_el.value) + (mem_zone * 36e5)
	const t = new Date(Date.now() + offset)
	display(t)
	const r = 1000 - (t % 1000)
	window.synchronizeTimeout = window.setTimeout(synchronize, r)
}

function zeropad2(s){
	return ('0' + s).slice(-2)
}

const char_masks = {
	'0': 0b111111,
	'1': 0b1001,
	'2': 0b1110101,
	'3': 0b1101101,
	'4': 0b1001011,
	'5': 0b1101110,
	'6': 0b1111110,
	'7': 0b1101,
	'8': 0b1111111,
	'9': 0b1101111,
	' ': 0,
	'.': 0b100000000,
	'-': 0b1000000,
	'_': 0b100000,
	'+': 0b111000000,
	':': 0b110000000,
	'A': 0b1011111,
	'B': 0b1000000110101101,
	'C': 0b110110,
	'D': 0b110101101,
	'E': 0b1110110,
	'F': 0b1010110,
	'G': 0b1000000000111110,
	'H': 0b1011011,
	'I': 0b110100100,
	'J': 0b111001,
	'K': 0b1100001011011,
	'L': 0b110010,
	'M': 0b110011111,
	'N': 0b0000011111,
	'O': 0b111111,
	'P': 0b1010111,
	'Q': 0b1000000111111,
	'R': 0b1001011111,
	'S': 0b1101110,
	'T': 0b110000100,
	'T2': 0b1000010110,
	'T3': 0b100000001101,
	'U': 0b111011,
	'V': 0b100010011,
	'W': 0b100111011,
	'X': 0b1111001011011,
	'Y': 0b101000011,
	'Z': 0b1110101,
	'?': 0b11111111111,
}

const db = [[4,11.625], [6,11.625], [6,9], [5,8.25], [4,9]]
const dc = [[.25,14], [9.75,14], [7.75,12], [2.25,12]]
const dl = [[0,13.75], [2,11.75], [2,8.25], [1,7.25], [0,8.25]]
const dlt = [[-.375,14], [-4,14], [-3,12], [-.375,12]]
const drt = [[10.375,14], [14,14], [13,12], [10.375,12]]
const dr = [[10,13.75], [8,11.75], [8,8.25], [9,7.25], [10,8.25]]
const ult = [[-.375,0], [-4,0], [-3,2], [-.375,2]]
const urt = [[10.375,0], [14,0], [13,2], [10.375,2]]
const mc = [[1.25, 7], [2.25,6], [7.75,6], [8.75, 7], [7.75,8], [2.25,8]]
const mr = [[5,6], [7.75,6], [8.75, 7], [7.75,8], [5,8]]
const mlt = [[-4, 7], [-3,6], [-.25,6], [.75, 7], [-.25,8], [-3,8]]
const mrt = [[14, 7], [13,6], [10.25,6], [9.25, 7], [10.25,8], [13.25,8]]
const ub = [[4,2.375], [6,2.375], [6,5], [5,5.75], [4,5]]
const uc = [[.25,0], [9.75,0], [7.75,2], [2.25,2]]
const ul = [[0,.25], [2,2.25], [2,5.75], [1,6.75], [0,5.75]]
const ur = [[10,.25], [8,2.25], [8,5.75], [9,6.75], [10,5.75]]

const segs = [ur, ul, uc, dr, dl, dc, mc, ub, db, ult, dlt, urt, drt, mlt, mrt, mr]

function mask_segs(mask){
	let s = []
	let i = 0
	let i_mask = 1
	while(i_mask <= mask){
		if(mask & i_mask){
			s.push(segs[i])
		}
		++i
		i_mask = i_mask << 1
	}
	return s
}

const char_paths = Object.fromEntries(
	Object.entries(char_masks).map(
		([k, mask], i) => [k, mask_segs(mask)]
	)
)

function shape(path, x, y, m = 1){
	m = m*z
	c.beginPath()
	c.moveTo((path[0][0] + x)*m, (path[0][1] + y)*m)
	for(i=1; i<path.length; ++i){
		c.lineTo((path[i][0] + x)*m, (path[i][1] + y)*m)
	}
	c.fill()
}

function draw_char(s, x, y, m = 1){
	(char_paths[s] || char_paths['?']).forEach(
		path => shape(path, x, y, m)
	)
}

function draw_str(chars, x, y, m = 1, gw = grid_w){
	if(!(chars instanceof Array)){
		chars = (chars+'').split('')
	}
	chars.forEach((s, i) => {
		draw_char(s, x + i * gw, y, m)
	})
}
const tau = 2 * Math.PI
const colon_sides = 6
const colon_radius = 1.16
const colon_shape = Array(colon_sides).fill().map((_,i)=>([
	colon_radius * Math.cos(i * tau / colon_sides),
	colon_radius * Math.sin(i * tau / colon_sides),
]))
function colon(x, y){
	shape(colon_shape, x, y+5)
	shape(colon_shape, x, y+9)
}

const button_box = document.getElementById('button_box')
function resize(event){
	const scale = window.devicePixelRatio || 1
	z = Math.floor(Math.min(
		window.innerWidth / width,
		window.screen.availWidth / width,
		(window.innerHeight  - button_box.offsetHeight) / height,
		(window.screen.availHeight - button_box.offsetHeight) / height,
	))
	can.height = height * scale * z
	can.width = width * scale * z
	can.style.height = (height*z)+'px'
	can.style.width = (width*z)+'px'
	c.scale(scale, scale)
	synchronize()
}

window.addEventListener('resize', resize)
window.screen.orientation.addEventListener('change', resize)

const dash = [[2.25, 7], [3.25,6], [6.75,6], [7.75, 7], [6.75,8], [3.25,8]]
const zone_bg_shape = [[0,0],[3*grid_w,0],[3*grid_w,char_height],[0,char_height]]

function display(t){
	const day_of_month = zeropad2(t.getUTCDate())
	const month = zeropad2(t.getUTCMonth()+1)
	const month_name = months[t.getUTCMonth()].padStart(4)
	const year = t.getUTCFullYear()
	const weekday = weekdays[t.getUTCDay()]
	const hours = zeropad2(t.getUTCHours())
	const minutes = zeropad2(t.getUTCMinutes())
	const seconds = zeropad2(t.getUTCSeconds())

	c.fillStyle = palettes.color
	c.clearRect(0, 0, width*z, height*z)
	let x = 0, y = pad_v, m = .25
	draw_str(month_name, x = pad_h/m + grid_w*9.25, y/m, m)
	draw_str(weekday, x += grid_w*6.5, y/m, m)
	y += 6
	m = .5
	draw_str(year, x = pad_h/m, y/m, m)
	draw_str(month, x += 4.75*grid_w, y/m, m)
	draw_str(day_of_month, x += 2.75*grid_w, y/m, m)
	shape(dash,	pad_h + 4*grid_w, y + grid_h - 5, m)
	shape(dash,	pad_h + 6.75*grid_w, y + grid_h - 5, m)
	y += 10
	draw_str(hours, x = pad_h, y)
	colon(x+29.5, y)
	draw_str(minutes, x += grid_w2+7, y)
	m = 0.75
	draw_str(seconds, (x + grid_w2)/m, (y+3.5)/m, m)

	m = .1
	const tiles = 24
	for(var i = 0; i < tiles; ++i){
		let zone = i - 11
		let lit = zone === mem_zone
		c.fillStyle = palettes[1]
		lit && shape(
			zone_bg_shape,
			(width-4)/m,
			1/m + i * grid_h,
			m,
		)
		c.fillStyle = palettes[lit ? 3 : 2]
		draw_str(zone_desc(zone),
			(width-4)/m,
			1/m + i * grid_h,
			m,
		)
	}
	y += 16
	m = 0.5
	c.fillStyle = palettes[1]
	const city_codes = city_info.filter(a => a[0] === mem_zone)
	if(city_codes.length > 1){
		draw_str(city_codes.map(a => a[1]).join('.'), pad_h/m, y/m, m)
	}
	if(city_codes.length === 1){
		draw_str(city_codes[0][2].toUpperCase().slice(0,12), pad_h/m, y/m, m)
	}
}

setTheme('Dark')
resize()

</script>