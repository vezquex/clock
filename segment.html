<!doctype html>
<meta charset='utf-8'/>
<meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>
	Segmented Clock
</title>
<style type='text/css'>
	:root {color-scheme: dark;}
	body, input, select {
		background: #000;
		color: #FFF;
		display: flex;
		flex-direction: column;
		font-family: sans-serif;
		font-size: 1em;
		margin: 0;
	}
	label {
		display: flex;
	}
	input, select, .label {
		border: 0;
		padding: .5em;
	}
	select {
		flex-grow: 1;
	}
</style>

<input id='offset' title='Demo Offset' value='0' type='range' max='86400000' step='100000' onChange='synchronize()'>
<label>
	<span class='label'>Theme</span>
	<select id='theme' title='Theme' onChange='setTheme(this.value)'></select>
</label>
<div><canvas id='face'></canvas></div>

<script type='text/javascript'>

let palettes
const color_palettes = {
	'black': '#242224',
	'blue': '#0080DB',
	'green': '#00ED00',
	'red': '#F10000',
	'white': '#F1EDDB',
}
const themes = {
	Dark: {
		background: color_palettes.black,
		color: color_palettes.white,
	},
	Light: {
		background: color_palettes.white,
		color: color_palettes.black,
	},
	Blue: {
		background: color_palettes.black,
		color: color_palettes.blue,
	},
	Green: {
		background: color_palettes.black,
		color: color_palettes.green,
	},
	Red: {
		background: color_palettes.black,
		color: color_palettes.red,
	},
}
for(k in themes){
	const theme = themes[k]
	;(theme._scale||[]).forEach((color, i)=>theme[i] = color_palettes[color])
	Object.assign(theme, color_palettes)
}
document.getElementById('theme').innerHTML = Object.keys(themes).map(t => `<option value='${t}'>${t}</option>`).join('')


const dcale = 'en-us'

const _ = void 0

const can = document.getElementById('face')
const c = can.getContext('2d')

const height = 40
const width = 100
const pad_h = 4
const pad_v = 4
const char_height = 10
const char_width = 14
const grid_w = char_width + 2
const grid_w2 = grid_w * 2

// zoom
const z = 8
can.height = height * z
can.width = width * z

const offset_el = document.getElementById('offset')

function setTheme(theme){
	palettes = themes[theme]
	can.style.backgroundColor = palettes.background
	document.querySelector(`#theme [value=${theme}]`).selected = true
	synchronize()
}

// display at the start of each second
function synchronize(){
	window.clearTimeout(window.synchronizeTimeout)
	const offset = Number(offset_el.value)
	const t = new Date(Date.now() + offset)
	display(t)
	const r = 1000 - (t % 1000)
	window.synchronizeTimeout = window.setTimeout(synchronize, r)
}

function zeropad2(s){
	return ('0' + s).slice(-2)
}

function shape(path, x, y){
	c.beginPath()
	c.moveTo((path[0][0] + x)*z, (path[0][1] + y)*z)
	for(i=1; i<path.length; ++i){
		c.lineTo((path[i][0] + x)*z, (path[i][1] + y)*z)
	}
	c.fill()
}

const db = [[4,11.5], [6,11.5], [6,9], [5,8.25], [4,9]]
const dc = [[.25,14], [9.75,14], [8,12], [2,12]]
const dl = [[0,7.25], [2,9], [2,11.5], [0,13.5]]
const dr = [[10,7.25], [8,8.5], [8,11.5], [10,13.5]]
const lt = [[-.25,.25], [-2,0], [-2,2], [-.25,2]]
const mc = [[.5, 7], [2,6], [8,6], [9.5, 7], [8,8], [2,8]]
const ub = [[4,2.5], [6,2.5], [6,5], [5,5.75], [4,5]]
const uc = [[.25,0], [9.75,0], [8,2], [2,2]]
const ul = [[0,.5], [2,2.5], [2,5.5], [0,6.75]]
const ur = [[10,.5], [8,2.5], [8,5.5], [10,6.75]]

const segs = [ur, ul, uc, dr, dl, dc, mc, ub, db, lt]
const char_masks = {
	'0': 0b111111,
	'1': 0b1001,
	'2': 0b1110101,
	'3': 0b1101101,
	'4': 0b1001011,
	'5': 0b1101110,
	'6': 0b1111110,
	'7': 0b1101,
	'8': 0b1111111,
	'9': 0b1101111,
	' ': 0,
	'-': 0b100000000,
	':': 0b110000000,
	'A': 0b1011111,
	'E': 0b1110110,
	'F': 0b1010110,
	'H': 0b1011011,
	'L': 0b0110010,
	'M': 0b110011111,
	'O': 0b111111,
	'R': 0b1001011111,
	'S': 0b1101110,
	'T': 0b110000100,
	'T2': 0b1000010110,
	'U': 0b111011,
	'W': 0b100111011,
	'?': 0b1111111111,
}

function mask_segs(mask){
	let s = []
	let i = 0
	let i_mask = 1
	while(i_mask <= mask){
		if(mask & i_mask){
			s.push(segs[i])
		}
		++i
		i_mask = i_mask << 1
	}
	return s
}

const paths = []

const char_paths = Object.fromEntries(
	Object.entries(char_masks).map(
		([k, mask], i) => [k, mask_segs(mask)]
	)
)

const locale = 'en-us'

function draw_char(s, x, y){
	char_paths[s].forEach(
			path => shape(path, x, y)
		)
}

function draw_str(str, x, y){
	(str+'').split('').forEach((s, i) => {
		draw_char(s, x + i * grid_w, y)
	})
}

function display(t){
	const month = ((t.getMonth() + 1)+'').padStart(2)
	const weekday = t.toLocaleString(locale, { weekday: 'short' }).toUpperCase().slice(0,2)
	const hours = (t.getHours()+'').padStart(2)
	const minutes = zeropad2(t.getMinutes())
	const seconds = zeropad2(t.getSeconds())
	const day_of_month = t.getDate()

	c.fillStyle = palettes.color
	c.clearRect(0, 0, width*z, height*z)
	let x = pad_h, y = pad_v
	draw_str(weekday, x, y)
	draw_str(month, x+=grid_w2, y)
	draw_char('-', x+24, y)
	draw_str(day_of_month, x+=grid_w2, y)
	x = pad_h
	y += 18
	draw_str(hours, x, y)
	draw_char(':', x+24, y)
	draw_str(minutes, x+=grid_w2, y)
	draw_char(':', x+24, y)
	draw_str(seconds, x+=grid_w2, y)
}

setTheme('Light')

synchronize()

</script>
